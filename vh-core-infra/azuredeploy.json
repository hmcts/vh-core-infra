{
  "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "MSSQLDBServerName": {
      "type": "string",
      "minLength": 1
    },
    "MSSQLDBName": {
      "type": "string",
      "minLength": 1
    },
    "MSSQLAdminLogin": {
      "type": "string",
      "minLength": 1
    },
    "MSSQLServerEdition": {
      "type": "string",
      "defaultValue": "Standard",
      "allowedValues": [
        "Basic",
        "Standard",
        "Premium"
      ]
    },
    "MSSQLRequestedServiceObjectiveName": {
      "type": "string",
      "defaultValue": "S0",
      "allowedValues": [
        "Basic",
        "S0",
        "S1",
        "S2",
        "S3",
        "S4",
        "P1",
        "P2",
        "P3"
      ],
      "metadata": {
        "description": "Describes the performance level for Edition"
      }
    },
    "MSSQLEmailAddresses": {
      "type": "securestring"
    },
    "vaultSku": {
      "type": "string",
      "defaultValue": "Standard",
      "allowedValues": [
        "Standard",
        "Premium"
      ],
      "metadata": {
        "description": "SKU for the vault"
      }
    },
    "tenantId": {
      "type": "string",
      "defaultValue": "[subscription().tenantId]",
      "metadata": {
        "description": "Tenant Id of the subscription. Get using Get-AzureRmSubscription cmdlet or Get Subscription API"
      }
    },
    "location": {
      "type": "string",
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "Location for all resources."
      }
    },
    "appServicePlanName": {
      "type": "string"
    },
    "sku": {
      "type": "string",
      "defaultValue": "S1"
    },
    "tier": {
      "type": "string",
      "defaultValue": "standard"
    },
    "keyVaultName": {
      "type": "string"
    },
    "keyVaultNameHearingsTenant": {
      "type": "string"
    },
    "objectId": {
      "type": "string"
    },
    "secretsPermissions": {
      "type": "array",
      "defaultValue": [
        "list",
        "get"
      ],
      "metadata": {
        "description": "Permissions to secrets in the vault. Valid values are: all, get, set, list, and delete."
      }
    },
    "appInsightsName": {
      "type": "string"
    },
    "appInsightsLocation": {
      "type": "string",
      "defaultValue": "West Europe"
    },
    "RedisCacheName": {
      "type": "string"
    },
    "KeyVaultCertificateSecretName": {
      "type": "string"
    },
    "_artifactsLocation": {
      "type": "string",
      "defaultValue": "https://raw.githubusercontent.com/hmcts/vh-arm-templates/master/vh-arm-templates"

    }
  },
  "variables": {
    "AzureKeyVaultTemplateFolder": "AzureKeyVault",
    "AzureKeyVaultTemplateFileName": "AzureKeyVault.json",
    "AzureKeyVaultTemplateParametersFileName": "AzureKeyVault.parameters.json",
    "AzureKeyVaultAccessPolicyTemplateFolder": "AzureKeyVaultAccessPolicy",
    "AzureKeyVaultAccessPolicyTemplateFileName": "AzureKeyVaultAccessPolicy.json",
    "AzureKeyVaultAccessPolicyTemplateParametersFileName": "AzureKeyVaultAccessPolicy.parameters.json",
    "AzureAppServicePlanTemplateFolder": "AzureAppServicePlan",
    "AzureAppServicePlanTemplateFileName": "AzureAppServicePlan.json",
    "AzureAppServicePlanTemplateParametersFileName": "AzureAppServicePlan.parameters.json",
    "AzureApplicationInsightsTemplateFolder": "AzureApplicationInsights",
    "AzureApplicationInsightsTemplateFileName": "AzureApplicationInsights.json",
    "AzureApplicationInsightsTemplateParametersFileName": "AzureApplicationInsights.parameters.json",
    "AzureMSSQLTemplateFolder": "AzureMSSQL",
    "AzureMSSQLTemplateFileName": "AzureMSSQL.json",
    "AzureMSSQLTemplateParametersFileName": "AzureMSSQL.parameters.json",
    "AzureRedisCacheTemplateFolder": "AzureRedisCache",
    "AzureRedisCacheTemplateFileName": "AzureRedisCache.json",
    "AzureRedisCacheTemplateParametersFileName": "AzureRedisCache.parameters.json",
    "AzureMSSQLDatabaseTemplateFolder": "AzureMSSQLDatabase",
    "AzureMSSQLDatabaseTemplateFileName": "AzureMSSQLDatabase.json"
  },
  "resources": [
    {
      "name": "AzureAppServicePlan",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2016-09-01",
      "dependsOn": [
        "KeyVault",
        "AzureKeyVaultAccessPolicy"
      ],
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[concat(parameters('_artifactsLocation'), '/', variables('AzureAppServicePlanTemplateFolder'), '/', variables('AzureAppServicePlanTemplateFileName'))]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "appServicePlanName": { "value": "[parameters('appServicePlanName')]" },
          "sku": { "value": "[parameters('sku')]" },
          "tier": { "value": "[parameters('tier')]" },
          "KeyVaultSecretName": { "value": "[parameters('KeyVaultCertificateSecretName')]" },
          "KeyVaultId": { "value": "[reference('KeyVault').outputs.AzureKeyVaultResourceId.value]" }

        }
      }
    },
    {
      "name": "KeyVault",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2017-05-10",
      "dependsOn": [],
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[concat(parameters('_artifactsLocation'), '/', variables('AzureKeyVaultTemplateFolder'), '/', variables('AzureKeyVaultTemplateFileName'))]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "keyVaultName": { "value": "[parameters('keyVaultName')]" }
        }
      }
    },
    {
      "name": "AzureKeyVaultAccessPolicy",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2016-09-01",
      "dependsOn": [ "KeyVault" ],
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[concat(parameters('_artifactsLocation'), '/', variables('AzureKeyVaultAccessPolicyTemplateFolder'), '/', variables('AzureKeyVaultAccessPolicyTemplateFileName'))]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "keyVaultName": { "value": "[parameters('keyVaultName')]" },
          "objectId": { "value": "[parameters('objectId')]" },
          "SecretsPermissions": { "value": "[parameters('secretsPermissions')]" }
        }
      }
    },
    {
      "name": "keyVaultNameHearingsTenant",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2017-05-10",
      "dependsOn": [],
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[concat(parameters('_artifactsLocation'), '/', variables('AzureKeyVaultTemplateFolder'), '/', variables('AzureKeyVaultTemplateFileName'))]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "keyVaultName": { "value": "[parameters('keyVaultNameHearingsTenant')]" }
        }
      }
    },
    {
      "name": "AzureKeyVaultAccessPolicykeyVaultNameHearingsTenant",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2016-09-01",
      "dependsOn": [ "KeyVault" ],
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[concat(parameters('_artifactsLocation'), '/', variables('AzureKeyVaultAccessPolicyTemplateFolder'), '/', variables('AzureKeyVaultAccessPolicyTemplateFileName'))]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "keyVaultName": { "value": "[parameters('keyVaultNameHearingsTenant')]" },
          "objectId": { "value": "[parameters('objectId')]" },
          "SecretsPermissions": { "value": "[parameters('secretsPermissions')]" }
        }
      }
    },
    {
      "name": "AzureApplicationInsights",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2016-09-01",
      "dependsOn": [],
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[concat(parameters('_artifactsLocation'), '/', variables('AzureApplicationInsightsTemplateFolder'), '/', variables('AzureApplicationInsightsTemplateFileName'))]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "appInsightsName": { "value": "[parameters('appInsightsName')]" },
          "location": { "value": "[parameters('appInsightsLocation')]" }
        }
      }
    },
    {
      "name": "AzureMSSQL",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2016-09-01",
      "dependsOn": [],
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[concat(parameters('_artifactsLocation'), '/', variables('AzureMSSQLTemplateFolder'), '/', variables('AzureMSSQLTemplateFileName'))]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "MSSQLAdminLogin": { "value": "[parameters('MSSQLAdminLogin')]" },
          "MSSQLDBName": { "value": "[parameters('MSSQLDBName')]" },
          "MSSQLDBServerName": { "value": "[parameters('MSSQLDBServerName')]" },
          "MSSQLRequestedServiceObjectiveName": { "value": "[parameters('MSSQLRequestedServiceObjectiveName')]" },
          "EmailAddresses": { "value": "[parameters('MSSQLEmailAddresses')]" }
        }
      }
    },
    {
      "name": "AzureRedisCache",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2016-09-01",
      "dependsOn": [],
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[concat(parameters('_artifactsLocation'), '/', variables('AzureRedisCacheTemplateFolder'), '/', variables('AzureRedisCacheTemplateFileName'))]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "RedisCacheName": { "value": "[parameters('RedisCacheName')]" }
        }
      }
    },
    {
      "name": "AzureMSSQLDatabase",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2016-09-01",
      "dependsOn": [ ],
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[concat(parameters('_artifactsLocation'), '/', variables('AzureMSSQLDatabaseTemplateFolder'), '/', variables('AzureMSSQLDatabaseTemplateFileName'))]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "MSSQLAdminLogin": { "value": "[parameters('MSSQLAdminLogin')]" },
          "MSSQLDBName": { "value": "[parameters('MSSQLDBName')]" },
          "MSSQLDBServerName": { "value": "[parameters('MSSQLDBServerName')]" },
          "MSSQLRequestedServiceObjectiveName": { "value": "[parameters('MSSQLRequestedServiceObjectiveName')]" },
        }
      }
    }
  ],
  "outputs": {
    "DatabaseConnectionString": {
      "type": "string",
      "value": "[reference('AzureMSSQL').outputs.DatabaseConnectionString.value]"
    },
    "InstrumentationKey": {
      "type": "string",
      "value": "[reference('AzureApplicationInsights').outputs.ApplicationInsightsInstrumentationKey.value]"
    },
    "RedisCacheConnectionString": {
      "type": "string",
      "value": "[reference('AzureRedisCache').outputs.RedisCacheConnectionString.value]"
    }
  }
}