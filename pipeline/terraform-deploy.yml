parameters:
  storageAccount: ""
  armServiceConnection: ""
  dnsServiceConnection: ""
  idamTenantId: ""
  idamClientId: ""
  idamClientSecret: ""
  environment: ""

steps:
  - template: terraform-loginprep.yml
    parameters:
      storageAccount: ${{ parameters.storageAccount }}
      armServiceConnection: ${{ parameters.armServiceConnection }}
      dnsServiceConnection: ${{ parameters.dnsServiceConnection }}
      idamTenantId: ${{ parameters.idamTenantId }}
      idamClientId: ${{ parameters.idamClientId }}
      idamClientSecret: ${{ parameters.idamClientSecret }}
  
  - task: DownloadPipelineArtifact@2
    displayName: Download Terraform Plan
    inputs:
      artifactName: tfplan-${{ parameters.environment }}
      targetPath: '$(Pipeline.Workspace)\sdf'

  - task: AzureCLI@2
    inputs:
      azureSubscription: ${{ parameters.armServiceConnection }}
      scriptType: pscore
      scriptLocation: inlineScript
      failOnStandardError: true
      inlineScript: |
        terraform apply -auto-approve plan.tfplan
    displayName: Terraform apply
    condition: succeeded()
